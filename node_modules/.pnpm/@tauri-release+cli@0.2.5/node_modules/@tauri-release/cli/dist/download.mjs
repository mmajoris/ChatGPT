import path from 'path';
import fs from 'fs';
import { $ as $argv, a as $, R as ROOT_PATH } from './shared/cli.8f57657e.mjs';
import 'module';

function download() {
  const argv = $argv();
  if (!argv.mdfile) {
    console.log($.red("[\u{1F4A2} download]"), `Could not found file`);
    return;
  }
  const fileList = argv.mdfile.split(",");
  if (fileList.length > 0) {
    fileList.forEach(write);
  }
}
function write(filePath, idx) {
  const startRe = `<!-- tr-download-start -->`;
  const endRe = `<!-- tr-download-end -->`;
  const argv = $argv();
  let ignoreLines = [];
  if (argv[`f${idx + 1}`]) {
    ignoreLines = `${argv[`f${idx + 1}`]}`?.split(",")?.map((i) => +i);
  }
  const file = path.join(ROOT_PATH, filePath);
  if (!fs.existsSync(file)) {
    console.log($.red("[\u{1F4A2} download]"), `Could not found ${$.yellow(file)}`);
    process.exit(0);
  }
  const content = fs.readFileSync(file, "utf8").split("\n");
  let isStart = false;
  for (let i = 0; i < content.length; i++) {
    const line = content[i];
    if (new RegExp(startRe).test(line)) {
      isStart = true;
    }
    if (isStart) {
      if (!ignoreLines.includes(i + 1)) {
        content[i] = content[i].replace(/(\d+).(\d+).(\d+)/g, argv.version);
      } else {
        console.log($.green("[\u2935\uFE0F  download]"), "ignore line number", $.green(i + 1));
      }
    }
    if (new RegExp(endRe).test(line)) {
      break;
    }
  }
  fs.writeFileSync(file, content.join("\n"), "utf8");
  console.log($.green("[\u2705 download]"), $.yellow(argv.version), $.gray(file));
}

export { download as default };
